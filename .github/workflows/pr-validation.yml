name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
        continue-on-error: true

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          git merge-base --is-ancestor origin/${{ github.base_ref }} HEAD || {
            echo "âš ï¸ This branch is behind the base branch"
            exit 1
          }

      - name: Validate file changes
        run: |
          echo "ðŸ“ Files changed in this PR:"
          git diff --name-only origin/${{ github.base_ref }}...HEAD
          
          # Check if package.json was modified directly (should use tools)
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^package.json$"; then
            echo "âš ï¸ Warning: package.json was modified directly"
            echo "Consider using dependency management tools instead"
          fi

      - name: Comment PR info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const additions = files.reduce((sum, file) => sum + file.additions, 0);
            const deletions = files.reduce((sum, file) => sum + file.deletions, 0);
            
            const comment = `## ðŸ“Š PR Statistics
            
            - **Files changed:** ${files.length}
            - **Lines added:** +${additions}
            - **Lines deleted:** -${deletions}
            - **Net change:** ${additions - deletions} lines
            
            Remember to:
            - âœ… Update documentation if needed
            - âœ… Add tests for new features
            - âœ… Ensure all CI checks pass
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
